#!/bin/bash
set -e

# –§—É–Ω–∫—Ü–∏—è –¥–ª—è –≤—ã–≤–æ–¥–∞ —Å–æ–æ–±—â–µ–Ω–∏–π —Å –≤—Ä–µ–º–µ–Ω–Ω–æ–π –º–µ—Ç–∫–æ–π
log() {
  echo "[$(date +'%Y-%m-%d %H:%M:%S')] $1"
}

# –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è –∏ –≤—ã–≤–æ–¥–∞ –ø–æ–¥—Ä–æ–±–Ω–æ—Å—Ç–µ–π –æ—à–∏–±–∫–∏
error_log() {
  local error_msg="$1"
  local error_code="$2"
  log "‚ùå –û—à–∏–±–∫–∞: ${error_msg} (–∫–æ–¥: ${error_code})"
  log "üìã –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –ø—Ä–æ–≤–µ—Ä—å—Ç–µ —Å–∏—Å—Ç–µ–º–Ω—ã–µ –∂—É—Ä–Ω–∞–ª—ã –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ–π –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏."
}

log "üîß –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–≥–æ —Ä–µ–∑–µ—Ä–≤–Ω–æ–≥–æ –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏—è"

# –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤ (–∑–Ω–∞—á–µ–Ω–∏—è –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é)
HOUR=1
MINUTE=0
DAYS="*"  # –ö–∞–∂–¥—ã–π –¥–µ–Ω—å
BACKUP_SCRIPT="$(pwd)/scripts/backup.sh"
LOG_DIR="$(pwd)/logs"
LOG_FILE="${LOG_DIR}/backup.log"

# –°–ø—Ä–∞–≤–∫–∞ –ø–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—é
show_help() {
    echo "–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ: $0 [–æ–ø—Ü–∏–∏]"
    echo ""
    echo "–û–ø—Ü–∏–∏:"
    echo "  -h, --help         –ü–æ–∫–∞–∑–∞—Ç—å —ç—Ç—É —Å–ø—Ä–∞–≤–∫—É"
    echo "  -H, --hour –ß–ê–°     –ß–∞—Å –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è (0-23), –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é: 1"
    echo "  -m, --minute –ú–ò–ù   –ú–∏–Ω—É—Ç–∞ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è (0-59), –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é: 0"
    echo "  -d, --days –î–ù–ò     –î–Ω–∏ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è (0-7 –∏–ª–∏ mon,tue,...), –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é: * (–∫–∞–∂–¥—ã–π –¥–µ–Ω—å)"
    echo "  -l, --log –§–ê–ô–õ     –ü—É—Ç—å –∫ —Ñ–∞–π–ª—É –∂—É—Ä–Ω–∞–ª–∞, –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é: ${LOG_FILE}"
    echo ""
    echo "–ü—Ä–∏–º–µ—Ä—ã:"
    echo "  $0 -H 3 -m 30                  –í—ã–ø–æ–ª–Ω—è—Ç—å –≤ 3:30 –∫–∞–∂–¥—ã–π –¥–µ–Ω—å"
    echo "  $0 -d 1,3,5 -H 2               –í—ã–ø–æ–ª–Ω—è—Ç—å –≤ 2:00 –ø–æ –ø–æ–Ω–µ–¥–µ–ª—å–Ω–∏–∫–∞–º, —Å—Ä–µ–¥–∞–º –∏ –ø—è—Ç–Ω–∏—Ü–∞–º"
    exit 0
}

# –û–±—Ä–∞–±–æ—Ç–∫–∞ –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤ –∫–æ–º–∞–Ω–¥–Ω–æ–π —Å—Ç—Ä–æ–∫–∏
while [ "$#" -gt 0 ]; do
    case "$1" in
        -h|--help)
            show_help
            ;;
        -H|--hour)
            HOUR="$2"
            if ! [[ "$HOUR" =~ ^[0-9]+$ ]] || [ "$HOUR" -lt 0 ] || [ "$HOUR" -gt 23 ]; then
                error_log "—á–∞—Å –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å —á–∏—Å–ª–æ–º –æ—Ç 0 –¥–æ 23" 1
                exit 1
            fi
            shift 2
            ;;
        -m|--minute)
            MINUTE="$2"
            if ! [[ "$MINUTE" =~ ^[0-9]+$ ]] || [ "$MINUTE" -lt 0 ] || [ "$MINUTE" -gt 59 ]; then
                error_log "–º–∏–Ω—É—Ç–∞ –¥–æ–ª–∂–Ω–∞ –±—ã—Ç—å —á–∏—Å–ª–æ–º –æ—Ç 0 –¥–æ 59" 1
                exit 1
            fi
            shift 2
            ;;
        -d|--days)
            DAYS="$2"
            shift 2
            ;;
        -l|--log)
            LOG_FILE="$2"
            LOG_DIR=$(dirname "$LOG_FILE")
            shift 2
            ;;
        *)
            error_log "–ù–µ–∏–∑–≤–µ—Å—Ç–Ω—ã–π –ø–∞—Ä–∞–º–µ—Ç—Ä: $1" 1
            show_help
            ;;
    esac
done

# –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞–ª–∏—á–∏—è —Å–∫—Ä–∏–ø—Ç–∞ —Ä–µ–∑–µ—Ä–≤–Ω–æ–≥–æ –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏—è
if [ ! -f "${BACKUP_SCRIPT}" ]; then
    error_log "–°–∫—Ä–∏–ø—Ç —Ä–µ–∑–µ—Ä–≤–Ω–æ–≥–æ –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏—è –Ω–µ –Ω–∞–π–¥–µ–Ω: ${BACKUP_SCRIPT}" 1
    exit 1
fi

# –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø—Ä–∞–≤ –Ω–∞ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–µ
if [ ! -x "${BACKUP_SCRIPT}" ]; then
    log "üîß –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –ø—Ä–∞–≤–∞ –Ω–∞ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–µ –¥–ª—è —Å–∫—Ä–∏–ø—Ç–∞ —Ä–µ–∑–µ—Ä–≤–Ω–æ–≥–æ –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏—è"
    chmod +x "${BACKUP_SCRIPT}" || { error_log "–ù–µ —É–¥–∞–ª–æ—Å—å —É—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –ø—Ä–∞–≤–∞ –Ω–∞ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–µ" 1; exit 1; }
fi

# –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞–ª–∏—á–∏—è cron
if ! command -v crontab &> /dev/null; then
    error_log "crontab –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω. –£—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ cron:" 1
    log "sudo apt-get update && sudo apt-get install -y cron"
    exit 1
fi

# –°–æ–∑–¥–∞–Ω–∏–µ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏ –¥–ª—è –ª–æ–≥–æ–≤, –µ—Å–ª–∏ –µ—ë –Ω–µ—Ç
if [ ! -d "${LOG_DIR}" ]; then
    log "üìÅ –°–æ–∑–¥–∞–Ω–∏–µ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏ –¥–ª—è –∂—É—Ä–Ω–∞–ª–æ–≤: ${LOG_DIR}"
    mkdir -p "${LOG_DIR}" || { error_log "–ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ–∑–¥–∞—Ç—å –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—é ${LOG_DIR}" 1; exit 1; }
fi

# –§–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–∏–µ —Å—Ç—Ä–æ–∫–∏ –¥–ª—è crontab
CRON_JOB="${MINUTE} ${HOUR} * * ${DAYS} cd $(pwd) && ${BACKUP_SCRIPT} >> ${LOG_FILE} 2>&1"

# –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –∑–∞–¥–∞–Ω–∏—è –≤ crontab
log "üìù –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –∑–∞–¥–∞–Ω–∏—è –≤ crontab: '${CRON_JOB}'"
(crontab -l 2>/dev/null | grep -v "${BACKUP_SCRIPT}" || true; echo "${CRON_JOB}") | crontab -

log "‚úÖ –ó–∞–¥–∞–Ω–∏–µ –¥–æ–±–∞–≤–ª–µ–Ω–æ –≤ crontab. –†–µ–∑–µ—Ä–≤–Ω–æ–µ –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏–µ –±—É–¥–µ—Ç –≤—ã–ø–æ–ª–Ω—è—Ç—å—Å—è –≤ ${HOUR}:${MINUTE} –ø–æ –¥–Ω—è–º: ${DAYS}"
log "üìù –ñ—É—Ä–Ω–∞–ª –±—É–¥–µ—Ç —Å–æ—Ö—Ä–∞–Ω—è—Ç—å—Å—è –≤: ${LOG_FILE}"

# –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç–∞—Ç—É—Å–∞ cron
log "üîç –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç–∞—Ç—É—Å–∞ —Å–ª—É–∂–±—ã cron..."
if command -v systemctl &> /dev/null; then
    CRON_STATUS=$(systemctl is-active cron)
    if [ "${CRON_STATUS}" != "active" ]; then
        log "‚ö†Ô∏è –°–ª—É–∂–±–∞ cron –Ω–µ –∞–∫—Ç–∏–≤–Ω–∞! –ó–∞–ø—É—Å—Ç–∏—Ç–µ –µ—ë –∫–æ–º–∞–Ω–¥–æ–π: sudo systemctl start cron"
    else
        log "‚úÖ –°–ª—É–∂–±–∞ cron –∞–∫—Ç–∏–≤–Ω–∞ –∏ —Ä–∞–±–æ—Ç–∞–µ—Ç"
    fi
fi

log "üîç –¢–µ–∫—É—â–∏–µ –∑–∞–¥–∞–Ω–∏—è crontab:"
crontab -l 