name: –î–µ–ø–ª–æ–π

on:
  workflow_run:
    workflows: ["–ü—É–±–ª–∏–∫–∞—Ü–∏—è"]
    types:
      - completed
    branches:
      - main

jobs:
  deploy:
    name: –î–µ–ø–ª–æ–π –Ω–∞ —Å–µ—Ä–≤–µ—Ä
    runs-on: ubuntu-latest
    if: ${{ github.event.workflow_run.conclusion == 'success' }}

    steps:
      - uses: actions/checkout@v4

      - name: –ù–∞—Å—Ç—Ä–æ–π–∫–∞ SSH
        uses: webfactory/ssh-agent@v0.9.0
        with:
          ssh-private-key: ${{ secrets.SSH_PRIVATE_KEY }}

      - name: –î–æ–±–∞–≤–ª–µ–Ω–∏–µ —Ö–æ—Å—Ç–∞ –≤ known_hosts
        run: |
          mkdir -p ~/.ssh
          ssh-keyscan -H ${{ secrets.SERVER_HOST }} >> ~/.ssh/known_hosts

      - name: –ö–æ–ø–∏—Ä–æ–≤–∞–Ω–∏–µ —Ñ–∞–π–ª–æ–≤ –Ω–∞ —Å–µ—Ä–≤–µ—Ä
        run: |
          scp docker-compose.prod.yml ${{ secrets.SERVER_USER }}@${{ secrets.SERVER_HOST }}:~/notio/
          scp .env.prod ${{ secrets.SERVER_USER }}@${{ secrets.SERVER_HOST }}:~/notio/.env

      - name: –î–µ–ø–ª–æ–π –Ω–∞ —Å–µ—Ä–≤–µ—Ä
        uses: appleboy/ssh-action@v1.0.0
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          script: |
            cd ~/notio
            docker compose -f docker-compose.prod.yml pull
            docker compose -f docker-compose.prod.yml up -d
            docker system prune -f

  notify:
    name: –£–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –æ –¥–µ–ø–ª–æ–µ
    needs: deploy
    runs-on: ubuntu-latest
    if: always()

    steps:
      - name: –û—Ç–ø—Ä–∞–≤–∫–∞ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –≤ Telegram
        uses: appleboy/telegram-action@v0.1.1
        with:
          to: ${{ secrets.TELEGRAM_CHAT_ID }}
          token: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          message: |
            üöÄ –î–µ–ø–ª–æ–π ${{ github.repository }}
            
            –°—Ç–∞—Ç—É—Å: ${{ needs.deploy.result == 'success' && '‚úÖ –£—Å–ø–µ—à–Ω–æ' || '‚ùå –û—à–∏–±–∫–∞' }}
            –í–µ—Ç–∫–∞: ${{ github.ref_name }}
            –ö–æ–º–º–∏—Ç: ${{ github.sha }}
            
            –ü–æ–¥—Ä–æ–±–Ω–æ—Å—Ç–∏: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }} 